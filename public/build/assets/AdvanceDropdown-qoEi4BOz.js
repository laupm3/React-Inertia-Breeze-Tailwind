import{r as c,j as i,a as $,R as N}from"./app-fwyInB3c.js";import"./Create-tmHr2JLD.js";import{P as B,a as H,b as M}from"./popover-DaRbHQOK.js";import{D as _,a as L,b as z}from"./dialog-iaZkf6Xy.js";import{I as G,D as X}from"./InputSkeleton-CFMfUb-2.js";import{u as J,D as W}from"./DataTableContext-BYrqyX0i.js";import{B as R}from"./Button-CQuYVLGu.js";import{I as q}from"./LucideIcon-CEqEhMjI.js";import{A as Q}from"./AdvancedHeader-CpvwMmYr.js";import{r as Y}from"./RowActionsColumn-CM2slffX.js";const v={DEFAULT_CACHE_DURATION:5*60*1e3,CLEANUP_INTERVAL:5*60*1e3,MAX_UNUSED_AGE:30*60*1e3,FETCH_DEBOUNCE:1e3},C={};let D=null;function Z(){const r=new Date;let t=0;Object.entries(C).forEach(([o,h])=>{h.subscribers.size===0&&h.lastAccessed&&r-h.lastAccessed>v.MAX_UNUSED_AGE&&(delete C[o],t++)}),t>0&&console.debug(`Cache cleanup: removed ${t} unused entries`),Object.keys(C).length===0&&D&&(clearInterval(D),D=null)}function K(){D||(D=setInterval(Z,v.CLEANUP_INTERVAL))}const T=c.createContext(null);function y(){const r=c.useContext(T);if(!r)throw new Error("useDataHandler debe usarse dentro de DataHandlerContextProvider");return r}function I(r,t,o,h,l,f){return{data:[],loading:!1,error:null,subscribers:new Set,lastFetched:null,lastFetchAttempt:null,lastAccessed:new Date,cacheDuration:f,updateAccessTime(){this.lastAccessed=new Date},isFresh(){return this.updateAccessTime(),this.lastFetched&&new Date-this.lastFetched<this.cacheDuration},notify(){const n={data:this.data,loading:this.loading,error:this.error};this.subscribers.forEach(e=>e(n))},async fetchData(n=!1){if(this.updateAccessTime(),this.loading&&!n)return;const e=new Date;if(!(!n&&this.lastFetchAttempt&&e-this.lastFetchAttempt<v.FETCH_DEBOUNCE)){this.lastFetchAttempt=e,this.loading=!0,this.error=null,this.notify();try{if(!t)throw new Error("URL no definida");const s=await $.get(t);if(s.status===200){let a;o?(a=s.data[o],a===void 0&&(a=[])):a=s.data,Array.isArray(a)||(a=a?[a]:[]);try{const u=h(a);this.data=Array.isArray(u)?u:u?[u]:[]}catch{this.data=a,this.error="Error al transformar datos"}this.lastFetched=new Date}else this.data=[],this.error=`Error de respuesta: ${s.status}`}catch(s){this.data=[],this.error=s.message||"Error desconocido"}finally{this.loading=!1,this.notify()}}},invalidateCache(){return this.updateAccessTime(),this.lastFetched=null,this.fetchData(!0)},updateData(n){this.updateAccessTime();const e=h([n])[0],s=l(e);this.data.some(u=>l(u)===s)?this.data=[e,...this.data.filter(u=>l(u)!==s)]:this.data=[e,...this.data],this.lastFetched=new Date,this.notify(),te()},addItem(n){this.updateAccessTime();const e=h([n])[0];this.data=[e,...this.data],this.lastFetched=new Date,this.notify()},updateBulk(n){if(!(n!=null&&n.length))return;this.updateAccessTime();const e=h(n),s=new Map(this.data.map(a=>[l(a),a]));e.forEach(a=>s.set(l(a),a)),this.data=Array.from(s.values()),this.lastFetched=new Date,this.notify()}}}function ee({children:r,fetchUrl:t,dataKey:o,transformData:h=n=>n,getItemId:l=n=>n==null?void 0:n.id,cacheDuration:f=v.DEFAULT_CACHE_DURATION}){c.useMemo(K,[]);const n=c.useMemo(()=>{var d;return`${((d=t==null?void 0:t.replace)==null?void 0:d.call(t,/\/$/,""))||"unknown"}::${o||""}::${f}`},[t,o,f]);C[n]||(C[n]=I(n,t,o,h,l,f));const e=C[n];e.updateAccessTime();const[s,a]=c.useState({data:e.data||[],loading:e.loading||!1,error:e.error||null});c.useEffect(()=>{const w=p=>a(p);return e.subscribers.add(w),a({data:e.data,loading:e.loading,error:e.error}),!e.loading&&(e.data.length===0||!e.lastFetched||!e.isFresh())&&e.fetchData(),()=>{e.subscribers.delete(w),e.subscribers.size===0&&e.updateAccessTime()}},[n]);const u=c.useMemo(()=>({data:s.data,loading:s.loading,error:s.error,fetchData:e.fetchData.bind(e),updateData:e.updateData.bind(e),addItem:e.addItem.bind(e),updateBulk:e.updateBulk.bind(e),invalidateCache:e.invalidateCache.bind(e),isFresh:e.isFresh.bind(e),getItemId:l}),[s,e,l]);return i.jsx(T.Provider,{value:u,children:r})}function te(r=null){if(r){const t=C[r];t?console.log(`Cache entry for ${r}:`,{data:t.data.length,loading:t.loading,error:t.error,subscribers:t.subscribers.size,lastFetched:t.lastFetched,lastAccessed:t.lastAccessed}):console.log(`No cache entry found for ${r}`);return}console.log(`Total cache entries: ${Object.keys(C).length}`),Object.entries(C).forEach(([t,o])=>{console.log(`${t}:`,{data:o.data.length,loading:o.loading,error:o.error,subscribers:o.subscribers.size,lastFetched:o.lastFetched,lastAccessed:o.lastAccessed})})}function ne(){const{sheetView:r,handleSheetView:t,enableSheetTableView:o,SheetTableViewComponent:h}=F(),{open:l,model:f}=r;return!f||!o?null:i.jsx(h,{model:f,open:l,onOpenChange:()=>t(f)})}const P=c.createContext(null),se=({children:r,enableCreateUpdateView:t=!1,enableSheetTableView:o=!1,CreateUpdateViewComponent:h=null,SheetTableViewComponent:l=null})=>{const[f,n]=c.useState({open:!1,model:null}),[e,s]=c.useState({open:!1,model:null}),a=d=>{n(p=>({open:!p.open,model:w(d)}))},u=d=>{s(p=>({open:!p.open,model:w(d)}))},w=d=>(d==null?void 0:d.id)??d??null;return i.jsx(P.Provider,{value:{createUpdateView:f,setCreateUpdateView:n,sheetView:e,setSheetView:s,handleCreateUpdateView:a,handleSheetView:u,enableCreateUpdateView:t,enableSheetTableView:o,CreateUpdateViewComponent:h,SheetTableViewComponent:l},children:r})};function F(){const r=c.useContext(P);if(!r)throw new Error("useView debe usarse dentro de ViewContextProvider");return r}function re(){const{createUpdateView:r,handleCreateUpdateView:t,enableCreateUpdateView:o,CreateUpdateViewComponent:h}=F(),{updateData:l}=y(),{open:f,model:n}=r;return o?i.jsx(h,{model:n,open:f,onOpenChange:()=>t(n),onSaveData:l}):null}function ae({}){const{viewContext:r}=J()||{},t=(r==null?void 0:r.handleCreateUpdateView)!==void 0,o=c.useCallback(()=>{t&&r.handleCreateUpdateView(null)},[t,r]);return i.jsxs(R,{onClick:o,variant:"ghost",className:"text-custom-blackSemi font-normal flex gap-2 w-full items-center justify-start text-start dark:hover:text-custom-gray-light dark:text-custom-gray-semiLight rounded-md hover:bg-custom-gray-semiLight px-1",children:[i.jsx(q,{name:"Plus",className:"w-5","aria-hidden":"true"}),i.jsx("span",{className:"sm:inline text-sm",children:"Añadir registro"})]})}const oe=c.memo(ae),O=c.createContext(null),ie=({children:r,defaultValue:t=null,onChangeValue:o=()=>{},renderSelection:h=null,dropdownContent:l=null,placeholder:f="Selecciona una opción",getItemId:n,handleResponse:e=()=>{}})=>{const[s,a]=c.useState({value:null,rowSelection:{}}),u=c.useRef(!1),w=c.useRef(null),d=c.useRef(!1),p=c.useRef(t),{data:g}=y(),A=c.useCallback(m=>{if(d.current)return!1;d.current=!0,u.current=!0;try{const x=typeof m=="function"?m(s.rowSelection):m,S=Object.keys(x).find(j=>x[j]);if(s.value&&S&&String(n(s.value))===String(S))return a({value:null,rowSelection:{}}),!0;const k=S?g.find(j=>String(n(j))===String(S)):null;return e(k),a({value:k,rowSelection:x}),!0}finally{d.current=!1}},[g,n,s.rowSelection,e]);c.useEffect(()=>{if(!(!g||g.length===0||d.current)&&!(p.current===t&&s.value)){if(t==null){u.current||a({value:null,rowSelection:{}});return}if(s.value&&String(n(s.value))===String(t)){p.current=t;return}d.current=!0;try{p.current!==t&&(u.current=!1),p.current=t;const m=g.find(x=>String(n(x))===String(t));if(m){const x=n(m);a({value:m,rowSelection:{[x]:!0}})}}finally{d.current=!1}}},[g,t,n]),c.useEffect(()=>{if(!d.current)if(s.value){const m=n(s.value);if(w.current===m)return;u.current&&(w.current=m,o(m,s.value))}else u.current&&w.current!==null&&(w.current=null,o(null,null))},[s.value,o,n]);const b={selection:s,setSelection:a,handleRowSelectionChange:A,renderSelection:h,dropdownContent:l,placeholder:f,getItemId:n,resetSelection:c.useCallback(()=>{u.current=!1,a({value:null,rowSelection:{}})},[]),forceSelection:c.useCallback(m=>{if(m){d.current=!0;try{const x=n(m);a({value:m,rowSelection:{[x]:!0}}),w.current=x}finally{d.current=!1}}},[n])};return i.jsx(O.Provider,{value:b,children:r})};function U(){const r=c.useContext(O);if(!r)throw new Error("useAdvanceDropdown debe usarse dentro de AdvanceDropdownContextProvider");return r}const E=c.forwardRef((r,t)=>{const{selection:o,placeholder:h,renderSelection:l}=U(),{value:f}=o,n=e=>typeof e=="string"?e:(e==null?void 0:e.nombre)||(e==null?void 0:e.name)||(e==null?void 0:e.title)||(e==null?void 0:e.label)||JSON.stringify(e);return i.jsx(R,{ref:t,type:"button",variant:"secondary",className:`w-full flex items-center justify-start text-start focus:outline-none focus:ring-0 focus:ring-offset-0 dark:hover:text-custom-gray-light font-normal ${f?"":"text-custom-gray"}`,...r,children:f?l?l(f):n(f):h})});E.displayName="SelectionButton";function le(){return c.useMemo(()=>[{id:"values",title:"Values",enableHiding:!1,enableSorting:!0,sortUndefined:"last",enableFiltering:!0,header:({column:t})=>i.jsx(Q,{column:t,className:"max-w-[250px]"}),cell:({row:t})=>i.jsxs("span",{children:["Registro: ",t.id]}),accessorFn:t=>t.id},Y],[])}const ce=N.memo(function({columns:t,showCreateButton:o=!1,openInDialog:h=!1}){const{data:l,loading:f,error:n}=y(),e=F(),s=le(),{selection:a,handleRowSelectionChange:u,getItemId:w}=U(),[d,p]=c.useState(!1),g=c.useMemo(()=>t||s,[t,s]),A=c.useMemo(()=>`data-${(l==null?void 0:l.length)||0}-${Date.now()}`,[l]),b=c.useCallback(S=>{u(S)&&p(!1)},[u]);if(c.useEffect(()=>{a.value&&p(!1)},[a.value]),f||l&&l.length===0)return i.jsx(G,{});if(n)return i.jsxs("div",{className:"text-red-500 text-sm p-2 border border-red-300 rounded",children:["Error al cargar datos: ",n]});const x=i.jsxs("div",{className:"flex flex-col gap-2 w-80 sm:w-full px-3 py-2 rounded-xl dark:dark-scrollbar dark:bg-custom-blackSemi max-h-[500px] bg-custom-white",children:[i.jsx("div",{className:"w-full max-h-[450px] overflow-y-auto dark:dark-scrollbar",children:i.jsx(X,{})}),o&&i.jsx(oe,{})]});return i.jsx(W,{data:l,columnsDef:g,config:{getRowId:S=>String(w(S)),onRowSelectionChange:b,enableMultiRowSelection:!1},initialState:{pagination:{pageIndex:0,pageSize:l.length},rowSelection:a.rowSelection},viewContext:e,children:h?i.jsxs(_,{open:d,onOpenChange:p,children:[i.jsx(L,{asChild:!0,children:i.jsx(E,{})}),i.jsx(z,{className:"p-0 border-none bg-transparent shadow-none max-w-[70vw] w-full",children:x})]}):i.jsxs(B,{open:d,onOpenChange:p,modal:!0,children:[i.jsx(H,{asChild:!0,children:i.jsx(E,{})}),i.jsx(M,{className:"p-0 border-none bg-transparent shadow-none",sideOffset:5,align:"start",children:x})]})},A)}),Ce=N.memo(function({defaultValue:t=null,onChangeValue:o=()=>{},renderSelection:h=null,getItemId:l=b=>b==null?void 0:b.id,fetchUrl:f=null,transformData:n=b=>b,dataKey:e=null,columns:s=null,enableCreateUpdateView:a=!1,enableSheetTableView:u=!1,CreateUpdateViewComponent:w=null,SheetTableViewComponent:d=null,cacheDuration:p=5*60*1e3,handleResponse:g=()=>{},openInDialog:A=!1}){return i.jsx("div",{className:"max-w-full w-full overflow-hidden",children:i.jsx(se,{enableCreateUpdateView:a,enableSheetTableView:u,CreateUpdateViewComponent:w,SheetTableViewComponent:d,children:i.jsx(ee,{fetchUrl:f,transformData:n,dataKey:e,getItemId:l,cacheDuration:p,children:i.jsxs(ie,{defaultValue:t,onChangeValue:o,renderSelection:h,getItemId:l,handleResponse:g,children:[i.jsx(ce,{columns:s,showCreateButton:a,openInDialog:A}),i.jsx(re,{}),i.jsx(ne,{})]})})})})});export{Ce as A};
