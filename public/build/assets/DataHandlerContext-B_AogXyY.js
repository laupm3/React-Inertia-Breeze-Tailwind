import{r as t,a as k,j as U}from"./app-fwyInB3c.js";import{toast as C}from"./index-WlsBA3k2.js";import{u as K,V as ee}from"./ViewContext-CnIG9GpY.js";const T=t.createContext(null);function oe(){const d=t.useContext(T);if(!d)throw new Error("useDataHandler debe usarse dentro de DataHandlerContextProvider");return d}const ne=({children:d})=>{const{processApproval:m,isProcessing:P}=K(),p=t.useRef(!1),w={manager:{label:"Manager de departamento",icon:"UserCheck",order:1},hr:{label:"Recursos Humanos",icon:"Users",order:2},direction:{label:"DirecciÃ³n",icon:"Crown",order:3}},[F,l]=t.useState([]),[I,V]=t.useState(!0),[H,S]=t.useState(0),[b,j]=t.useState([]),[L,M]=t.useState([]),[i,x]=t.useState(null),[R,f]=t.useState(!1),[_,h]=t.useState(!1),[O,te]=t.useState(!1),[z,A]=t.useState({createUpdate:{open:!1,model:null},sheet:{open:!1,model:null},delete:{open:!1,model:null}}),y=t.useCallback(async()=>{V(!0);try{const e=await k.get(route("api.v1.admin.solicitudes.index"));if(e.status===200){const r=(e.data.solicitudes||[]).filter(a=>a&&a.id!==void 0);l(r),j(e.data.user_approval_types||[]),M(e.data.approval_types||[]),p.current=!0}else l([]),p.current=!0}catch(e){console.error("Error al cargar datos:",e),l([]),p.current=!0}finally{V(!1)}},[]),v=t.useCallback(()=>{S(e=>e+1),y()},[]),c=t.useCallback(e=>{if(!e||e.id===void 0){console.error("updateData: newItem is invalid",e);return}l(r=>{const a=r.filter(s=>s&&s.id!==void 0);return a.findIndex(s=>s.id===e.id)!==-1?r.map(s=>s&&s.id===e.id?e:s):[e,...a]}),setTimeout(()=>{S(r=>r+1)},100)},[]),D=t.useCallback(e=>{l(r=>r.filter(a=>a&&a.id!==e)),setTimeout(()=>{S(r=>r+1)},100)},[]),q=t.useCallback((e,r)=>{l(a=>a.map(n=>n&&n.id===e?{...n,estado:r,updated_at:new Date().toISOString()}:n)),setTimeout(v,100)},[v]),o=t.useCallback((e,r)=>{A(a=>({...a,[e]:{...a[e],...r}}))},[]),B=t.useCallback(()=>{x(null),o("createUpdate",{open:!0,model:null})},[o]),G=t.useCallback(e=>{if(!e||!e.id){console.error("handleUpdateView: model is invalid",e);return}x(e),o("createUpdate",{open:!0,model:e})},[o]),J=t.useCallback(e=>{if(!e||!e.id){console.error("handleSheetView: model is invalid",e);return}o("sheet",{open:!0,model:e})},[o]),N=t.useCallback(e=>{if(!e||!e.id){console.error("handleDeleteView: model is invalid",e);return}o("delete",{open:!0,model:e})},[o]),u=t.useCallback(()=>{A({createUpdate:{open:!1,model:null},sheet:{open:!1,model:null},delete:{open:!1,model:null}}),x(null)},[]),Q=t.useCallback(async e=>{var r;f(!0),h(!1);try{const a=i?route("api.v1.admin.solicitudes.update",i.id):route("api.v1.admin.solicitudes.store"),s=await k[i?"patch":"post"](a,e,{headers:{"Content-Type":"multipart/form-data"}});if(s.status===200||s.status===201)return C.success(i?"Solicitud actualizada correctamente":"Solicitud creada correctamente"),(r=s.data)!=null&&r.solicitud?c(s.data.solicitud):v(),u(),!0}catch(a){return console.error("Error en el formulario:",a),h(!0),C.error("Error al procesar la solicitud"),!1}finally{f(!1)}},[i,c,v,u]),W=t.useCallback(async e=>{if(!e||!e.id)return console.error("handleDelete: model is invalid",e),!1;f(!0),h(!1);try{if((await k.delete(route("api.v1.admin.solicitudes.destroy",e.id))).status===200)return C.success("Solicitud eliminada correctamente"),D(e.id),u(),!0}catch(r){return console.error("Error al eliminar:",r),h(!0),C.error("Error al eliminar la solicitud"),!1}finally{f(!1)}},[D,u]),X=t.useCallback(async(e,r,a,n=null)=>{const s=e.id||e;try{return{success:await m(s,r,a,n,g=>{g&&g.solicitud&&c(g.solicitud)})}}catch(E){return console.error("Error en handleDropdownAction:",E),{success:!1}}},[m,c]),Y=t.useCallback(e=>w[e]||{label:e,icon:"User",order:999},[]),Z=t.useCallback(e=>b.includes(e),[b]);t.useEffect(()=>{p.current||y()},[]);const $={data:F,loading:I,dataVersion:H,userApprovalTypes:b,approvalTypes:L,approvalTypeMap:w,fetchData:y,updateData:c,deleteItem:D,updateSolicitudStatus:q,currentFormModel:i,isFormProcessing:R,formError:_,isFormLoading:O,viewStates:z,handleCreateView:B,handleUpdateView:G,handleSheetView:J,handleDeleteView:N,closeAllViews:u,handleSubmit:Q,handleDelete:W,processApproval:m,isProcessingApproval:P,handleDropdownAction:X,getApprovalTypeInfo:Y,canApproveAs:Z};return U.jsx(T.Provider,{value:$,children:U.jsx(ee,{children:d})})};export{ne as DataHandlerContextProvider,oe as useDataHandler};
