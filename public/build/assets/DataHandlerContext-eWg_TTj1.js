import{r as t,j as z}from"./app-fwyInB3c.js";import{e as G,s as J,a as K}from"./endOfWeek-DoVA-Yvp.js";import{a as Q,f as P}from"./format-Be40hyfq.js";import"./toDate-qOSwr3PX.js";import"./constants-BKFt95HM.js";const B=t.createContext(null);function ae(){const j=t.useContext(B);if(!j)throw new Error("useDataHandler debe usarse dentro de DataHandlerContextProvider");return j}const se=({children:j})=>{const[g,w]=t.useState([]),[N,F]=t.useState(!0),[x,U]=t.useState("week"),l=t.useRef(null),A=t.useRef(null),E=new Date,W={from:Q(E,{weekStartsOn:1}),to:G(E,{weekStartsOn:1})},[S,Y]=t.useState(W),[m,L]=t.useState({month:E.getMonth(),year:E.getFullYear()}),V=c=>{L({month:c.getMonth(),year:c.getFullYear()})},f=t.useCallback(async()=>{F(!0);let c,p;if(x==="month"){const _=J(new Date(m.year,m.month)),k=K(new Date(m.year,m.month));c=_,p=k}else c=S.from,p=S.to;const r=P(c,"yyyy-MM-dd"),y=P(p,"yyyy-MM-dd");try{const _=route("api.v1.user.fichajes.index",{from:r,to:y}),k=await axios.get(_);if(k.status===200){const I=(k.data.horarios||[]).filter(e=>{if(!e.fecha_inicio)return!1;const n=new Date(e.fecha_inicio),i=new Date(r),u=new Date(y);return n>=i&&n<=u}).map(e=>{const n=Array.isArray(e.descansosAdicionales)?e.descansosAdicionales:[],i=o=>{if(!o)return null;const s=new Date(o);return isNaN(s)?o.slice(11,16):s.toISOString().slice(11,16)};let u=e.descansoInicio||e.descanso_inicio||null,a=e.descansoFin||e.descanso_fin||null,D=[];if(n.length>0){const o=n.filter(s=>s.descanso_inicio).sort((s,d)=>new Date(s.descanso_inicio)-new Date(d.descanso_inicio)).map(s=>({inicio:i(s.descanso_inicio),fin:s.descanso_fin?i(s.descanso_fin):null})).filter(s=>s.inicio);D=o,o.length&&(u=o[0].inicio,o.find(d=>!d.fin)?a=null:a=o[o.length-1].fin)}return{...e,descansoInicio:u,descansoFin:a,descansos:D}}),R=e=>{if(!e)return null;const[n,i]=e.split(":").map(Number);return n*60+i},M={};I.forEach(e=>{const n=e.fecha_inicio;M[n]||(M[n]=[]),M[n].push(e)}),Object.values(M).forEach(e=>{const n={},i={};e.forEach(a=>{a.fichajeEntrada&&(n[a.fichajeEntrada]||(n[a.fichajeEntrada]=[]),n[a.fichajeEntrada].push(a)),a.fichajeSalida&&(i[a.fichajeSalida]||(i[a.fichajeSalida]=[]),i[a.fichajeSalida].push(a))});const u=(a,D=!0)=>{Object.entries(a).forEach(([H,o])=>{if(o.length<=1)return;let s=null,d=1/0;o.forEach(h=>{const O=D?h.horarioInicio:h.horarioFin;if(!O)return;const T=Math.abs(R(O)-R(H));T<d&&(d=T,s=h)}),o.forEach(h=>{h!==s&&(D?h.fichajeEntrada=null:h.fichajeSalida=null)})})};u(n,!0),u(i,!1)}),w(I)}else w([])}catch{w([])}finally{F(!1)}},[S,x,m]),C=t.useCallback(()=>{const c=g.some(r=>r.descansosAdicionales&&Array.isArray(r.descansosAdicionales)?r.descansosAdicionales.some(y=>y.descanso_inicio&&!y.descanso_fin):r.descansoInicio&&!r.descansoFin),p=g.some(r=>r.estado_fichaje==="en_pausa"||r.estado_fichaje==="descanso_obligatorio");return c||p},[g]),b=t.useCallback(()=>{l.current&&clearInterval(l.current),l.current=setInterval(()=>{const c=new Date;(!A.current||c-A.current>=15e3)&&(A.current=c,f())},3e4)},[f]),v=t.useCallback(()=>{l.current&&(clearInterval(l.current),l.current=null)},[]),q=t.useCallback(()=>{f()},[f]);return t.useEffect(()=>{f()},[f]),t.useEffect(()=>(C()?b():v(),()=>{v()}),[C,b,v]),t.useEffect(()=>()=>{l.current&&(clearInterval(l.current),l.current=null)},[]),z.jsx(B.Provider,{value:{data:g,setData:w,fetchData:f,loading:N,selectedRange:S,setSelectedRange:Y,monthSelected:m,manageMonthChange:V,viewType:x,setViewType:U,hasActiveBreaks:C,startRealTimeUpdates:b,stopRealTimeUpdates:v,forceRefresh:q},children:j})};export{se as DataHandlerContextProvider,ae as useDataHandler};
