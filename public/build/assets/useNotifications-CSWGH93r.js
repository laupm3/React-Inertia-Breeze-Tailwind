import{X as p,r as u,a as A}from"./app-fwyInB3c.js";const o={listeners:new Set,emit(i,a){this.listeners.forEach(l=>l(i,a))},subscribe(i){return this.listeners.add(i),()=>this.listeners.delete(i)}},v=()=>{const{auth:i,notifications:a}=p().props,[l,c]=u.useState(a||[]),[f,d]=u.useState([]),[_,m]=u.useState((a==null?void 0:a.filter(t=>!t.is_read).length)||0);return u.useEffect(()=>{m(l.filter(t=>!t.is_read).length)},[l]),u.useEffect(()=>o.subscribe((s,e)=>{s==="MARK_AS_READ"?c(r=>r.map(n=>n.id===e.id?{...n,is_read:!0}:n)):s==="MARK_AS_UNREAD"?c(r=>r.map(n=>n.id===e.id?{...n,is_read:!1}:n)):s==="MARK_ALL_AS_READ"?c(r=>r.map(n=>({...n,is_read:!0}))):s==="NEW_NOTIFICATION"?c(r=>r.some(n=>n.id===e.id)?r:[e,...r]):s==="NEW_CALENDAR_EVENT"&&d(r=>r.some(n=>n.id===e.id)?r:[...r,e])}),[]),u.useEffect(()=>{if(!window.Echo)return;const t=window.Echo.private(`App.Models.User.${i.user.id}`),s=window.Echo.channel("notifications");return t.notification(e=>{const r={id:e.id||Date.now(),title:e.title,content:e.message||e.content,sender:e.sender||{name:"Sistema"},sent_at:e.timestamp||e.sent_at||new Date().toISOString(),is_read:!1,...e};o.emit("NEW_NOTIFICATION",r)}),t.listen(".calendar.evento.created",e=>{if(e.evento){const r={id:e.evento.id,title:e.evento.title,start:e.evento.start,end:e.evento.end,color:e.evento.color,tipo:e.evento.tipo,descripcion:e.evento.descripcion,participantes:e.evento.participantes||[],user:e.evento.user||e.user||null,creator:e.evento.creator||e.creator||null,createdBy:e.evento.createdBy||e.createdBy||null,author:e.evento.author||e.author||null,owner:e.evento.owner||e.owner||null,_rawData:e};o.emit("NEW_CALENDAR_EVENT",r)}}),s.listen(".nueva_empresa",e=>{const r={...e.notification,id:e.notification.id||Date.now(),is_read:!1,sent_at:e.notification.sent_at||new Date().toISOString()};o.emit("NEW_NOTIFICATION",r)}),()=>{t.stopListening("notification"),t.stopListening(".calendar.evento.created"),s.stopListening(".nueva_empresa")}},[i.user.id]),{notifications:l,unreadCount:_,calendarEvents:f,markAsRead:async(t,s=!1)=>{try{return await A.put(route("api.v1.admin.notifications.markAsRead",t)),s||o.emit("MARK_AS_READ",{id:t}),!0}catch{return!1}},markAsUnread:async(t,s=!1)=>{try{return await A.put(route("api.v1.admin.notifications.markAsUnread",t)),s||o.emit("MARK_AS_UNREAD",{id:t}),!0}catch{return!1}},markAllAsRead:async()=>{try{return await A.put(route("api.v1.admin.notifications.markAllAsRead")),o.emit("MARK_ALL_AS_READ"),!0}catch{return!1}},refreshNotifications:async()=>{try{const t=await A.get(route("api.v1.admin.notifications.index"));return t.data&&t.data.notifications&&c(t.data.notifications),!0}catch{return!1}},setNotifications:c,setCalendarEvents:d}};export{v as u};
