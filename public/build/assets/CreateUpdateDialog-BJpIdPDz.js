import{r as s,a as z,j as x}from"./app-fwyInB3c.js";import{B as O}from"./button-Blwr-A5N.js";import{D as ai,b as ci,c as li,d as ui,e as fi,f as hi}from"./dialog-iaZkf6Xy.js";import{PermisoSelectionSection as di,DateTimeSection as mi,AdditionalDetailsSection as pi}from"./FormSections-BOaE6Vup.js";import{FileUploadSection as _i}from"./FileUploadSection-CYpiNal_.js";import{defaultPermisoValues as G}from"./PermisoSchema-B2DCh5cF.js";import{formatDate as Y}from"./dateUtils-rRvHNrPT.js";import{toast as v}from"./index-WlsBA3k2.js";import"./index-DloWbRVd.js";import"./index-BwobEAja.js";import"./utils-CytzSlOG.js";import"./index-DVo7DTeW.js";import"./index-DmpKZt4E.js";import"./index-p2DxCSsL.js";import"./index-B7srb2QZ.js";import"./index-BIJodELy.js";import"./index-DmaU4p-o.js";import"./index-CyKk8pQ_.js";import"./tslib.es6-BUas5LQb.js";import"./index-BZxTbISK.js";import"./x-2mzC_aTV.js";import"./createLucideIcon-DoJ0Kelj.js";import"./label-zCtqi3J5.js";import"./textarea-C969rVin.js";import"./checkbox-BQT_ir1e.js";import"./index-BxSEkZvI.js";import"./index-4A9uUPu1.js";import"./index-BZgm3BCW.js";import"./check-5DjPwM22.js";import"./input-CqlBlYgU.js";import"./LucideIcon-CEqEhMjI.js";import"./calendar-days-Dti00tYQ.js";import"./calendar-k1x2vwx8.js";import"./chevron-up-OjKdrhzc.js";import"./chevron-right-B1iws4WK.js";import"./user-plus-zM6CnMXf.js";import"./user-CNwXqt1W.js";import"./octagon-alert-BRAzZNeG.js";import"./PermisoAdvanceDropdown-CMmjCTaL.js";import"./Pill-l4GaXyto.js";import"./StatusTipoPermisoMapColor-uADlCWR0.js";import"./AdvanceDropdown-qoEi4BOz.js";import"./Create-tmHr2JLD.js";import"./AuthenticatedLayout-B4CSARVj.js";import"./sidebar-CPh6C6LB.js";import"./separator-BWKairMX.js";import"./sheet-DHc5Hgr8.js";import"./skeleton-DSiYFg9q.js";import"./tooltip-DFfoxvAF.js";import"./index-CLai1W86.js";import"./index-CeuhGnKJ.js";import"./dropdown-menu-bHoOJ61X.js";import"./index-C_F9oucK.js";import"./index-v24TFYKQ.js";import"./popover-DaRbHQOK.js";import"./avatar-oBOSifLN.js";import"./PopUpIncidencias-CaovAEi3.js";import"./card-DYkZYgg5.js";import"./Button-CQuYVLGu.js";import"./useTranslation-BtIkv0Na.js";import"./UserAvatar-cKyxDEhx.js";import"./ApplicationLogo-C2FcO4AY.js";import"./Yoopta-Dj4Guze5.js";import"./throttle-CmSTFqON.js";import"./PrimaryButton-SsXyLm2e.js";import"./DecisionModal-Dl8siGBG.js";import"./alert-dialog-kDfn0La3.js";import"./useNotifications-CSWGH93r.js";import"./ShowNotificactionFromJestream-cKOlvVdg.js";import"./OnboardingModal-D0HRNKzO.js";import"./Modal-BkRna8gK.js";import"./transition-ByAjZSmr.js";import"./StepItem-bNLmZaq8.js";import"./StepProgress-DNpLodXf.js";import"./WelcomeContent-BPJ5E7_N.js";import"./onboardingImages-CoczwfNn.js";import"./AboutContent-DOlAXyok.js";import"./TeamContent-C0DysUYq.js";import"./CreateLanguageForm-xwtvYsjX.js";import"./alert-D9izbOQG.js";import"./InputSkeleton-CFMfUb-2.js";import"./table-cS0UKUSm.js";import"./GlobalFilter-DNA5td8x.js";import"./DataTableContext-BYrqyX0i.js";import"./index-Z1g0u-qm.js";import"./TableDebugging-C1u6ii1k.js";import"./AdvancedHeader-CpvwMmYr.js";import"./command-PoUoScut.js";import"./badge-BgloL8Ae.js";import"./select-B5O0TxCl.js";import"./DatePicker-YJSItPq7.js";import"./calendar-DctTJhwg.js";import"./endOfWeek-DoVA-Yvp.js";import"./toDate-qOSwr3PX.js";import"./format-Be40hyfq.js";import"./constants-BKFt95HM.js";import"./addDays-B9Fzl-_R.js";import"./parseISO-Efi0RkWR.js";import"./RowActionsColumn-CM2slffX.js";import"./RowActionsTrigger-DnJzXomR.js";import"./PermisoStatsInline-Bx30kg1z.js";import"./charts-D-b4h_4c.js";import"./index-DpIruHMc.js";import"./PieChart-DDiBUCNq.js";import"./PolarAngleAxis-CNFzyAg3.js";import"./es-DNLwfvrq.js";import"./FileUploadArea-uzmkw7Uv.js";import"./types-BZmDMmQb.js";const K={START:"09:00",END:"17:00"},U={START:["00:00","02:00"],END:["23:59","01:59"]};function Fi(i=null){const[l,t]=s.useState(G),[F,S]=s.useState(void 0),[b,y]=s.useState(null),[f,r]=s.useState({hora_inicio:"",hora_fin:""}),[h,d]=s.useState(!1),w=!!i,n=(b==null?void 0:b.duracion)||null,a=n?Math.floor(n/(1e3*60*60*24)):null,o=l.fecha_inicio&&l.fecha_fin&&l.fecha_inicio===l.fecha_fin,u=l.fecha_inicio&&l.fecha_fin&&l.fecha_inicio!==l.fecha_fin,_=o&&!u,p=_&&!l.dia_completo,k=s.useCallback(()=>{t(G),S(void 0),y(null),r({hora_inicio:"",hora_fin:""}),d(!1)},[]),V=e=>{let c="",m="",g=!!e.dia_completo;const I=e.fecha_inicio?e.fecha_inicio.split("T")[0]:"",R=e.fecha_fin?e.fecha_fin.split("T")[0]:"";return I&&R&&I!==R&&(g=!0),e.fecha_inicio&&(c=new Date(e.fecha_inicio).toTimeString().slice(0,5)),e.fecha_fin&&(m=new Date(e.fecha_fin).toTimeString().slice(0,5)),U.START.includes(c)&&U.END.includes(m)&&(g=!0),g&&(c="",m=""),{horaInicio:c,horaFin:m,esDiaCompleto:g}},T=s.useCallback(e=>{var R,N;d(!0);const{horaInicio:c,horaFin:m,esDiaCompleto:g}=V(e);r({hora_inicio:g?"":c,hora_fin:g?"":m});const I={permiso_id:((R=e.permiso)==null?void 0:R.id)||e.permiso_id||((N=e.tipo_permiso)==null?void 0:N.id)||e.tipo_permiso_id||null,fecha_inicio:e.fecha_inicio?e.fecha_inicio.split("T")[0]:"",fecha_fin:e.fecha_fin?e.fecha_fin.split("T")[0]:"",hora_inicio:g?"":c,hora_fin:g?"":m,motivo:e.motivo||"",dia_completo:g,recuperable:!!e.recuperable,estado_id:e.estado_id||G.estado_id,files:[]};if(t(I),e.fecha_inicio&&e.fecha_fin){const C=e.fecha_inicio.split("T")[0],P=e.fecha_fin.split("T")[0];S({from:new Date(C+"T12:00:00"),to:new Date(P+"T12:00:00")})}e.permiso?y(e.permiso):e.tipo_permiso?y(e.tipo_permiso):console.warn("DEBUG - No se pudo encontrar información del tipo de permiso"),setTimeout(()=>{if(I.permiso_id===null){const C=e.permiso||e.tipo_permiso;C!=null&&C.id&&t(P=>({...P,permiso_id:C.id}))}d(!1)},150)},[]),L=s.useCallback(e=>{t(c=>{if(e){const m={hora_inicio:c.hora_inicio||f.hora_inicio,hora_fin:c.hora_fin||f.hora_fin};return r(m),{...c,dia_completo:!0,hora_inicio:"",hora_fin:""}}else{let m=f.hora_inicio,g=f.hora_fin;return(!m||U.START.includes(m))&&(m=K.START),(!g||U.END.includes(g))&&(g=K.END),r({hora_inicio:m,hora_fin:g}),{...c,dia_completo:!1,hora_inicio:m,hora_fin:g}}})},[f.hora_inicio,f.hora_fin]),E=s.useCallback((e,c)=>{if(e==="files"){const m=Array.isArray(c)?c:c?[c]:[];t(g=>({...g,[e]:m}))}else t(m=>({...m,[e]:c}))},[]),H=s.useCallback((e,c)=>{e==="dia_completo"?L(c):E(e,c)},[L,E]),q=s.useCallback(e=>{y(e),S(void 0),r({hora_inicio:"",hora_fin:""}),t(c=>({...c,permiso_id:(e==null?void 0:e.id)||null,fecha_inicio:"",fecha_fin:"",dia_completo:!1,hora_inicio:"",hora_fin:""}))},[]),B=s.useCallback(e=>{S(e)},[]);return s.useEffect(()=>{if(!h&&(F!=null&&F.from)&&(F!=null&&F.to)){const e=Y(F.from),c=Y(F.to);t(m=>m.fecha_inicio!==e||m.fecha_fin!==c?{...m,fecha_inicio:e,fecha_fin:c,...e!==c&&{dia_completo:!0,hora_inicio:"",hora_fin:""}}:m)}},[F,h]),{formData:l,dateRange:F,selectedPermiso:b,isInitializing:h,isEditing:w,maxDurationMs:n,maxDurationDays:a,isSingleDay:o,shouldForceFullDay:u,canShowCheckbox:_,canShowTimeFields:p,resetForm:k,initializeFormForEdit:T,handleInputChange:H,handlePermisoSelect:q,handleDateRangeChange:B,setFormData:t,setDateRange:S,setSelectedPermiso:y}}function gi(){const[i,l]=s.useState(null),[t,F]=s.useState(!1),[S,b]=s.useState(!1),y=async(n,a)=>{var o,u;b(!0);try{const _=`/api/v1/user/solicitudes/${n}/folder/${a}`;if((await z.delete(_)).status===200)return v.success("Archivo eliminado correctamente"),!0}catch(_){console.error("Error al eliminar archivo:",_);const p=((u=(o=_.response)==null?void 0:o.data)==null?void 0:u.message)||"Error al eliminar el archivo";return v.error(p),!1}finally{b(!1),F(!1),l(null)}};return{fileToDelete:i,showDeleteFileDialog:t,isDeletingFile:S,initiateFileDelete:(n,a,o=null)=>{l({permisoId:n,file:a,onSuccess:o}),F(!0)},confirmDeleteFile:async()=>{if(!i)return;await y(i.permisoId,i.file.hash)&&i.onSuccess&&i.onSuccess(i.file)},cancelFileDelete:()=>{F(!1),l(null)},addFilesToForm:(n,a,o)=>{const _=(Array.isArray(n)?n:Array.from(n)).filter(p=>!a.some(V=>V.name===p.name&&V.size===p.size&&V.lastModified===p.lastModified));_.length>0&&o(p=>{const k=[...p.files||[],..._];return{...p,files:k}})},removeFileFromForm:(n,a)=>{a(o=>{const u=o.files.filter((_,p)=>p!==n);return{...o,files:u}})},executeFileDelete:y}}function Si(i,l){const[t,F]=s.useState(new Set),[S,b]=s.useState(!1),y=s.useRef(null);s.useEffect(()=>{y.current||(y.current={permiso_id:i.permiso_id,fecha_inicio:i.fecha_inicio,fecha_fin:i.fecha_fin,hora_inicio:i.hora_inicio,hora_fin:i.hora_fin,motivo:i.motivo,dia_completo:i.dia_completo})},[]),s.useEffect(()=>{if(!y.current)return;const o=y.current;(i.permiso_id!==o.permiso_id||i.fecha_inicio!==o.fecha_inicio||i.fecha_fin!==o.fecha_fin||i.hora_inicio!==o.hora_inicio||i.hora_fin!==o.hora_fin||i.motivo!==o.motivo||i.dia_completo!==o.dia_completo)&&b(!0)},[i]);const f=o=>{F(u=>new Set([...u,o])),b(!0)};s.useEffect(()=>{var u,_;!i.permiso_id&&!i.motivo&&!i.hora_inicio&&!i.hora_fin&&i.fecha_inicio===((u=y.current)==null?void 0:u.fecha_inicio)&&i.fecha_fin===((_=y.current)==null?void 0:_.fecha_fin)&&(F(new Set),b(!1),y.current=null)},[i]);const r=s.useMemo(()=>!(!["permiso_id","fecha_inicio","fecha_fin","motivo"].every(_=>{const p=i[_];return _==="permiso_id"?p!=null&&p!==""&&p>0:p!=null&&p!==""})||!i.dia_completo&&(!i.hora_inicio||!i.hora_fin||i.hora_inicio>=i.hora_fin)),[i]),h=s.useMemo(()=>{if(!i.fecha_inicio||!i.fecha_fin||!(l!=null&&l.duracion))return{isValid:!0,message:""};const o=new Date(i.fecha_inicio),u=new Date(i.fecha_fin),_=Math.abs(u-o),p=Math.ceil(_/(1e3*60*60*24))+1,k=l.duracion,V=Math.floor(k/(1e3*60*60*24));return p>V?{isValid:!1,message:`La duración máxima permitida es de ${V} día(s)`}:{isValid:!0,message:""}},[i.fecha_inicio,i.fecha_fin,l]),d=s.useMemo(()=>{if(!i.fecha_inicio||!i.fecha_fin)return{isValid:!0,message:""};const o=new Date(i.fecha_inicio),u=new Date(i.fecha_fin),_=new Date;return _.setHours(0,0,0,0),o.setHours(0,0,0,0),u.setHours(0,0,0,0),o>u?{isValid:!1,message:"La fecha de inicio no puede ser posterior a la fecha de fin"}:u<_?{isValid:!1,message:"La fecha de fin no puede ser anterior a hoy"}:{isValid:!0,message:""}},[i.fecha_inicio,i.fecha_fin]),w=s.useMemo(()=>i.dia_completo?{isValid:!0,message:""}:!i.hora_inicio||!i.hora_fin?{isValid:!1,message:"Las horas de inicio y fin son requeridas"}:i.hora_inicio>=i.hora_fin?{isValid:!1,message:"La hora de inicio debe ser anterior a la hora de fin"}:{isValid:!0,message:""},[i.dia_completo,i.hora_inicio,i.hora_fin]),n=s.useMemo(()=>{if(!S)return[];const o=[];return!d.isValid&&(t.has("fecha")||S)&&o.push(d.message),!w.isValid&&(t.has("hora_inicio")||t.has("hora_fin")||S&&!i.dia_completo)&&o.push(w.message),!h.isValid&&i.fecha_inicio&&i.fecha_fin&&o.push(h.message),o},[d,w,h,S,t,i.dia_completo,i.fecha_inicio,i.fecha_fin]),a=n.length>0;return{isFormValid:r,hasValidationErrors:a,validationErrors:n,dateValidation:d,timeValidation:w,durationValidation:h,hasUserInitiatedAction:S,touchedFields:t,markFieldAsTouched:f}}function yi(){const[i,l]=s.useState(!1),t=f=>{const h=["permiso_id","fecha_inicio","fecha_fin","motivo"].filter(n=>{const a=f[n];return!a||typeof a=="string"&&a.trim()===""});if(h.length>0)throw new Error(`Campos requeridos faltantes: ${h.join(", ")}`);const d=new FormData,w={};return Object.entries(f).forEach(([n,a])=>{if(n==="files")Array.isArray(a)&&a.length>0&&a.forEach(o=>d.append("files[]",o));else if(typeof a=="boolean"){const o=a?"1":"0";d.append(n,o)}else if(a!=null){const o=a||"";d.append(n,o)}}),{requestData:d,headers:w}},F=async(f,r,h,d)=>d?r instanceof FormData?(r.append("_method","PUT"),await z.post(f,r,{headers:h})):await z.put(f,r,{headers:h}):await z.post(f,r,{headers:h}),S=async f=>{const{requestData:r,headers:h}=t(f);return await F("/api/v1/user/solicitudes",r,h,!1)},b=async(f,r)=>{const{requestData:h,headers:d}=t(f),w=`/api/v1/user/solicitudes/${r}`;return await F(w,h,d,!0)};return{isSubmitting:i,createPermiso:S,updatePermiso:b,handleSubmit:async(f,r,h)=>{var d,w,n,a;l(!0);try{let o;return r&&h?(o=await b(f,h),v.success("¡Permiso actualizado!",{description:"Los cambios en tu solicitud de permiso han sido guardados correctamente.",duration:5e3})):(o=await S(f),v.success("¡Permiso solicitado!",{description:"Tu solicitud de permiso ha sido enviada correctamente y está pendiente de aprobación.",duration:5e3})),o}catch(o){if((w=(d=o.response)==null?void 0:d.data)!=null&&w.errors){const u=Object.values(o.response.data.errors).flat();v.error("Errores de validación",{description:u.join(", "),duration:8e3})}else{const u=((a=(n=o.response)==null?void 0:n.data)==null?void 0:a.message)||(r?"Error al actualizar el permiso":"Error al solicitar el permiso");v.error("Error",{description:u,duration:5e3})}throw o}finally{l(!1)}}}}function Co({open:i,onOpenChange:l,permisoToEdit:t=null,onSuccess:F}){const[S,b]=s.useState(null),[y,f]=s.useState(!1),{formData:r,dateRange:h,selectedPermiso:d,isInitializing:w,isEditing:n,maxDurationMs:a,maxDurationDays:o,canShowCheckbox:u,canShowTimeFields:_,shouldForceFullDay:p,resetForm:k,initializeFormForEdit:V,handleInputChange:T,handlePermisoSelect:L,handleDateRangeChange:E,setFormData:H}=Fi(t),{fileToDelete:q,showDeleteFileDialog:B,isDeletingFile:e,initiateFileDelete:c,confirmDeleteFile:m,cancelFileDelete:g,removeFileFromForm:I}=gi(),{isFormValid:R,validationErrors:N,hasValidationErrors:C,markFieldAsTouched:P}=Si(r,d),{isSubmitting:$,handleSubmit:W}=yi(),J=async D=>{try{f(!0);const j=(await z.get(`/api/v1/user/solicitudes/${D}`)).data.solicitudPermiso;return b(j),j}catch(A){return console.error("Error al cargar permiso completo:",A),null}finally{f(!1)}};s.useEffect(()=>{i&&n&&(t!=null&&t.id)?J(t.id).then(D=>{D&&V(D)}):i&&!n&&k()},[i,t==null?void 0:t.id]),s.useEffect(()=>{i||(k(),b(null))},[i,k]);const Q=async()=>{if(!(!R||C))try{await W(r,n,t==null?void 0:t.id),l(!1),F&&F()}catch(D){console.error("Form submission error:",D)}},X=D=>{const A=Array.isArray(D)?D:D?[D]:[];H(j=>({...j,files:A}))},Z=D=>{I(D,H)},ii=D=>{t!=null&&t.id&&c(t.id,D,A=>{b(j=>{if(!j)return j;const ti=j.files.filter(M=>{const ni=M.id&&A.id&&M.id===A.id,si=M.hash&&A.hash&&M.hash===A.hash,ri=M.name===A.name&&M.size===A.size;return!(ni||si||ri)});return{...j,files:ti}})})},ei=!R||C||w||$,oi=(S==null?void 0:S.files)||(t==null?void 0:t.files)||[];return x.jsx(ai,{open:i,onOpenChange:l,children:x.jsxs(ci,{className:"bg-custom-white dark:bg-custom-blackLight max-w-3xl w-full max-h-[90vh] flex flex-col",children:[x.jsxs(li,{className:"flex-shrink-0",children:[x.jsx(ui,{children:n?"Editar Permiso":"Solicitar Permiso"}),x.jsx(fi,{children:n?"Modifica los datos de tu solicitud de permiso existente.":"Completa el formulario para solicitar un nuevo permiso."})]}),x.jsx("div",{className:"flex-1 overflow-y-auto",children:n&&y?x.jsxs("div",{className:"flex items-center justify-center py-8",children:[x.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-custom-orange"}),x.jsx("span",{className:"ml-2 text-custom-gray-dark dark:text-custom-gray-light",children:"Cargando datos del permiso..."})]}):x.jsxs("form",{className:"space-y-3 pr-2",children:[x.jsx(di,{selectedPermiso:d,onPermisoSelect:L,maxDurationDays:o,formData:r,dateRange:h}),x.jsx(mi,{dateRange:h,onDateRangeChange:E,formData:r,onInputChange:T,canShowCheckbox:u,canShowTimeFields:_,shouldForceFullDay:p,maxDurationMs:a,selectedPermiso:d,validationErrors:N,markFieldAsTouched:P,empleadoId:null}),x.jsx(pi,{formData:r,onInputChange:T}),x.jsx(_i,{existingFiles:oi,newFiles:r.files||[],onFilesAdd:X,onFileRemove:Z,onExistingFileDelete:ii,showDeleteDialog:B,fileToDelete:q,onConfirmDelete:m,onCancelDelete:g,isDeletingFile:e,isEditing:n})]})}),x.jsxs(hi,{className:"px-6 pb-4 pt-6 flex justify-end gap-4 flex-shrink-0 border-t border-custom-gray-light dark:border-custom-gray-darker",children:[x.jsx(O,{variant:"outline",onClick:()=>l(!1),disabled:$,className:"bg-hidden hover:bg-custom-gray-default dark:hover:bg-custom-blackSemi text-custom-black dark:text-custom-white rounded-full",children:"Cancelar"}),x.jsx(O,{onClick:Q,disabled:ei,className:"bg-custom-orange hover:bg-custom-blue text-custom-white dark:text-custom-black dark:hover:bg-custom-white rounded-full",children:$?n?"Actualizando...":"Creando...":n?"Guardar Cambios":"Solicitar Permiso"})]})]})})}export{Co as default};
